name: app-tv-build-action-dev

on:
    workflow_dispatch:
    push:
        branches:
            - dev
        paths:
            - 'simple_live_tv_app/**/*.dart'
            - 'simple_live_core/**/*.dart'

jobs:
    build:
        strategy:
            matrix:
                platform: [androidtv]
            fail-fast: false
        runs-on: ${{ matrix.platform == 'linux' && 'ubuntu-22.04' || 'macos-latest' }}
        continue-on-error: true

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: dev

            # Keystore é…ç½®
            - name: Setup keystore
              if: matrix.platform == 'androidtv'
              id: keystore
              uses: timheuer/base64-to-file@v1.2
              with:
                  fileName: keystore-${{ matrix.platform }}.jks
                  encodedString: ${{ secrets.TV_KEYSTORE_BASE64 }}

            - name: Create key.properties
              if: matrix.platform == 'androidtv'
              run: |
                  if [ "${{ matrix.platform }}" = "android" ]; then
                    APP_DIR=simple_live_app
                    STORE_PASSWORD=${{ secrets.STORE_PASSWORD }}
                    KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
                    KEY_ALIAS=${{ secrets.KEY_ALIAS }}
                  else
                    APP_DIR=simple_live_tv_app
                    STORE_PASSWORD=${{ secrets.TV_STORE_PASSWORD }}
                    KEY_PASSWORD=${{ secrets.TV_KEY_PASSWORD }}
                    KEY_ALIAS=${{ secrets.TV_KEY_ALIAS }}
                  fi

                  echo "storeFile=${{ steps.keystore.outputs.filePath }}" > $APP_DIR/android/key.properties
                  echo "storePassword=$STORE_PASSWORD" >> $APP_DIR/android/key.properties
                  echo "keyPassword=$KEY_PASSWORD" >> $APP_DIR/android/key.properties
                  echo "keyAlias=$KEY_ALIAS" >> $APP_DIR/android/key.properties

            - uses: actions/setup-java@v4
              if: matrix.platform == 'androidtv'
              with:
                  distribution: 'zulu'
                  java-version: '17'
                  cache: 'gradle'

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  channel: stable
                  flutter-version-file: simple_live_tv_app/pubspec.yaml
                  cache: true

            - name: Restore packages
              run: |
                  cd simple_live_tv_app
                  flutter pub get

            - name: Install fastforge
              run: dart pub global activate fastforge

            - name: Read version
              id: get_version
              run: |
                  VERSION=$(grep '^version:' simple_live_tv_app/pubspec.yaml | awk '{print $2}' | cut -d+ -f1)
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"

            - name: Build
              run: |
                  case "${{ matrix.platform }}" in
                    androidtv)
                      cd simple_live_tv_app
                      fastforge package --platform=android --targets=apk --skip-clean --flutter-build-args=split-per-abi
                      ;;
                  esac

            - name: Rename
              run: |
                  PLATFORM=${{ matrix.platform }}
                  VERSION=${{ steps.get_version.outputs.version }}
                  ARTIFACT_DIR=artifacts/$PLATFORM
                  mkdir -p $ARTIFACT_DIR

                  if [ "$PLATFORM" = "androidtv" ]; then
                    for f in simple_live_tv_app/build/app/outputs/flutter-apk/*.apk; do
                      [ -e "$f" ] || continue
                      EXT="${f##*.}"
                      ARCH=$(basename "$f" | sed -E 's/^app-(.*)-release\.apk$/\1/')
                      mv "$f" "$ARTIFACT_DIR/simple_live_tv-$PLATFORM-$ARCH.$EXT"
                    done
                  elif [ "$PLATFORM" = "ios" ]; then
                    mv simple_live_app/build/ios/iphoneos/ios_no_sign.ipa \
                      "$ARTIFACT_DIR/simple_live_app-$PLATFORM.ipa"
                  elif [ "$PLATFORM" = "linux" ]; then
                    for f in simple_live_app/build/dist/*/*.{deb,zip}; do
                      [ -e "$f" ] || continue
                      EXT="${f##*.}"
                      mv "$f" "$ARTIFACT_DIR/simple_live_app-$PLATFORM.$EXT"
                    done
                  elif [ "$PLATFORM" = "macos" ]; then
                    for f in simple_live_app/build/dist/*/*.{dmg,zip}; do
                      [ -e "$f" ] || continue
                      EXT="${f##*.}"
                      mv "$f" "$ARTIFACT_DIR/simple_live_app-$PLATFORM.$EXT"
                    done
                  fi

            - name: Upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.platform }}
                  path: artifacts/${{ matrix.platform }}/*

            - name: Show build status
              run: |
                  echo "ðŸ ${{ matrix.platform }} build status: ${{ job.status }}"

    release-dev:
        needs: [build]
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  merge-multiple: true

            - name: Install GitHub CLI
              run: sudo apt-get update && sudo apt-get install -y gh

            - name: Create or update GitHub Release
              run: |
                  TAG=nightly
                  echo "Publishing release for $TAG"

                  if gh release view "$TAG" --repo ${{ github.repository }} >/dev/null 2>&1; then
                    echo "Release $TAG already exists, updating notes..."
                    gh release edit "$TAG" \
                      --repo ${{ github.repository }}
                  else
                    gh release create "$TAG" \
                      --title "$TAG" \
                      --repo ${{ github.repository }}
                  fi

                  find artifacts -type f | xargs gh release upload "$TAG" --clobber --repo ${{ github.repository }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Release created
              run: echo "ðŸŽ‰ Pre-release dev updated."
